<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Burgos | Mapa y Buscador en Vivo (Auto-Refresco)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Incluir Leaflet Polyline Snake Flow para el efecto visual de la ruta -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-polyline-snake-flow/0.0.1/L.Polyline.SnakeFlow.min.js"></script>

    <style>
        /* Estilo base del mapa */
        #map {
            height: 55vh; /* REDUCIDO para ser m√°s peque√±o por defecto */
            min-height: 400px;
            width: 100%;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: height 0.4s ease, border-radius 0.4s ease; /* Transici√≥n para el cambio de tama√±o */
        }
        /* Clase para el modo pantalla completa del mapa */
        #map.map-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            height: 100vh; /* Ocupa toda la altura */
            min-height: 100vh;
            border-radius: 0; /* Sin bordes redondeados en fullscreen */
            z-index: 999; /* Asegura que est√© por encima de todo */
        }
        /* Estilo para el bot√≥n del popup de Leaflet (Para pantalla completa) */
        .leaflet-popup-content .fullscreen-toggle-btn {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            padding: 4px 8px;
            border-radius: 0.375rem;
            cursor: pointer;
            margin-top: 8px;
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            transition: background-color 0.2s;
        }
        .leaflet-popup-content .fullscreen-toggle-btn:hover {
            background-color: #e5e7eb;
        }
        /* Estilo para los marcadores de bus */
        .bus-icon {
            background-color: #2563EB; /* Azul primario */
            border: 3px solid #1E40AF;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            text-align: center;
            line-height: 30px;
            color: white;
            font-weight: bold;
            font-size: 15px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease-out;
            transform: scale(0.9);
        }
        .bus-icon:hover {
            transform: scale(1.1);
        }
        /* Estilo para los marcadores de parada (Ajustado para mejor control con Leaflet) */
        .stop-icon {
            background-color: white;
            border: 2px solid #1E40AF; /* Borde azul */
            border-radius: 50%;
            /* Definimos el tama√±o exacto en el CSS */
            width: 16px;
            height: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* Estilo para la m√°scara de carga (Spinner de Tailwind) */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            border-radius: 0.75rem;
            transition: opacity 0.3s ease;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8 font-sans">

    <!-- Bot√≥n de Casa Global (Visible en todos los modos excepto el men√∫ principal) -->
    <button id="home-btn" class="fixed top-4 left-4 z-50 bg-white text-blue-600 p-3 rounded-full shadow-lg hover:bg-gray-100 transition duration-150 ease-in-out hidden" title="Volver al Men√∫ Principal">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10l-2-2m-2 2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
        </svg>
    </button>
    
    <div id="app-container" class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 border-b-2 border-blue-500 pb-2">üöç Bus Burgos</h1>
            <p id="header-subtitle" class="text-gray-600 mt-2">Localizaci√≥n de veh√≠culos y horarios de parada en toda la red.</p>
        </header>

        <!-- PANTALLA PRINCIPAL: Men√∫ de Selecci√≥n -->
        <div id="menu-screen" class="bg-white p-6 rounded-xl shadow-2xl mb-8 flex flex-col items-center justify-center space-y-6" style="min-height: 400px;">
            <h2 class="text-2xl font-bold text-gray-800">Elige una opci√≥n</h2>
            <button id="btn-show-stops-map" class="w-full sm:w-80 bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition duration-150 ease-in-out text-xl">
                üìç Paradas Bus (Buscador)
            </button>
            <button id="btn-show-lines-list" class="w-full sm:w-80 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition duration-150 ease-in-out text-xl">
                üó∫Ô∏è L√≠neas Bus (Rutas y Buses en Vivo)
            </button>
        </div>

        <!-- VISTA DE MAPA GENERAL DE PARADAS (Controles del modo STOP_MAP) -->
        <div id="stops-map-controls" class="bg-white p-6 rounded-xl shadow-2xl mb-8 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Mapa General de Paradas</h2>

            <!-- Buscador de Bus por ID (REINCORPORADO) -->
            <div class="mb-6 border-b pb-4">
                <label for="bus-search-input" class="block text-sm font-bold text-gray-700 mb-2">üîé Buscar Autob√∫s por ID:</label>
                <div class="flex gap-3">
                    <input type="text" id="bus-search-input" placeholder="Ej: 152" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm transition">
                    <button id="bus-search-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">Buscar</button>
                </div>
            </div>

            <!-- Buscador de Paradas -->
            <div class="mb-6 border-b pb-4">
                <label for="stop-search-input" class="block text-sm font-bold text-gray-700 mb-2">üìç Buscar Parada por ID/Nombre:</label>
                <input type="text" id="stop-search-input" placeholder="Ej: 539 o Plaza de Espa√±a" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm transition">
                <div id="stop-search-results" class="mt-2 max-h-40 overflow-y-auto bg-gray-50 border border-gray-200 rounded-lg">
                    <!-- Resultados de la b√∫squeda se insertar√°n aqu√≠ -->
                </div>
            </div>

            <div id="status-message-stop-map" class="mt-4 text-sm font-medium p-3 rounded-lg hidden text-center"></div>
        </div>

        <!-- VISTA DE L√çNEA ESPEC√çFICA (Controles del modo LINE_VIEW) -->
        <div id="line-view-controls" class="bg-white p-6 rounded-xl shadow-2xl mb-8 hidden">
            <h2 id="line-view-title" class="text-2xl font-bold text-gray-800 mb-4">L√≠neas Bus: Listado</h2>
            
            <!-- Controles espec√≠ficos de la lista de l√≠neas -->
            <div id="lines-list-container" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                <!-- Lista de l√≠neas se insertar√° aqu√≠ -->
            </div>

            <!-- Controles de la l√≠nea activa (Selector de sentido) -->
            <div id="active-line-controls" class="hidden mt-4 pt-4 border-t">
                <label for="route-variant-select-line" class="block text-sm font-medium text-gray-700 mb-1">üîÑ Sentido de la Ruta:</label>
                <select id="route-variant-select-line" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm bg-gray-50" disabled>
                    <option value="">Cargando variantes...</option>
                </select>
                <div id="status-message-line-view" class="mt-4 text-sm font-medium p-3 rounded-lg hidden text-center"></div>
            </div>

        </div>

        <!-- Contenedor del Mapa (Com√∫n a STOP_MAP y LINE_VIEW) -->
        <div id="map-container-wrapper" class="relative hidden">
            <!-- Bot√≥n de Pantalla Completa para el Mapa -->
            <button id="fullscreen-btn" class="absolute top-2 right-2 z-[1001] bg-white text-gray-700 p-2 rounded-full shadow-lg hover:bg-gray-100 transition duration-150 ease-in-out" title="Pantalla Completa">
                <!-- Icono por defecto (Expandir) -->
                <svg id="fullscreen-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path id="fullscreen-path" stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 4l-5-5" />
                </svg>
            </button>
            
            <div id="map"></div>
            <div id="loading-overlay" class="loading-overlay hidden">
                <svg class="animate-spin h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-lg font-semibold text-gray-700">Iniciando monitor en tiempo real...</p>
            </div>
        </div>
    </div>

    <script>
        // === ADVERTENCIA CR√çTICA: PROBLEMA DE CORS ===
        const BASE_URL = 'https://www.aytoburgos.es/web/movilidad/rutas-en-directo';
        const CORS_PROXY = 'https://corsproxy.io/?'; 
        const POLLING_LINE_MS = 15000; // Refresco de buses de la l√≠nea activa (15s)
        const POLLING_STOP_MS = 10000; // Refresco de estimaciones de parada (10s)
        const POLLING_GLOBAL_MS = 60000; // Refresco global para el buscador (60s)
        const PORTLET_PREFIX = '_as_asac_isaenext_IsaenextWebPortlet_';
        const BASE_PARAMS = 'p_p_id=as_asac_isaenext_IsaenextWebPortlet&p_p_lifecycle=2&p_p_state=normal&p_p_mode=view&p_p_cacheability=cacheLevelPage';

        // --- ENUMS DE ESTADO (CR√çTICO PARA LA NAVEGACI√ìN) ---
        const VIEWS = {
            MENU: 'MENU',
            STOP_MAP: 'STOP_MAP', // Modo: Mapa con todas las paradas y buscador
            LINE_VIEW: 'LINE_VIEW' // Modo: Listado de l√≠neas o Mapa de l√≠nea individual
        };
        let currentView = VIEWS.MENU;
        let lineId = null; // Almacena la l√≠nea activa en el modo LINE_VIEW
        let targetBusIdOnLoad = null; // NUEVO: Para forzar el enfoque en un bus despu√©s de la navegaci√≥n

        const ALL_LINES = [
            '01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12', '13', '14', '15', '16', '17',
            '18', '19', '20', '21', '22', '23', '73', '87', '88', '89', 'C1', 'C2'
        ];

        // --- REQUISITO: Datos Est√°ticos de la Flota (Mantenidos) ---
        const BUS_FLEET_DATA = { 
            '134': { modelo: 'Castrosua CS.40 City Versus GNC', matricula: '126585 DVG', calca: '134' },
            '135': { modelo: 'Castrosua CS.40 City Versus GNC', matricula: '123566 DVG', calca: '135' },
            '137': { modelo: 'Castrosua CS.40 City Versus GNC', matricula: '127791 FJF', calca: '137' },
            '138': { modelo: 'Castrosua CS.40 City Versus GNC', matricula: '128054 FJF', calca: '138' },
            '139': { modelo: 'Castrosua CS.40 City Versus GNC', matricula: '128168 FJF', calca: '139' },
            '167': { modelo: 'Castrosua CS.40 City Versus GNC', matricula: '127933 JVR', calca: '167' },
            '168': { modelo: 'Castrosua CS.40 City Versus GNC', matricula: '128060 JVR', calca: '168' },
            '169': { modelo: 'Castrosua CS.40 City Versus GNC', matricula: '128117 JVR', calca: '169' },
            '179': { modelo: 'Castrosua CS.40 City Versus GNC', matricula: '127327 JZP', calca: '179' },
            '180': { modelo: 'Castrosua CS.40 City Versus GNC', matricula: '127360 JZP', calca: '180' },
            '181': { modelo: 'Castrosua CS.40 City Versus GNC', matricula: '127463 JZP', calca: '181' },
            '183': { modelo: 'Castrosua CS.40 City Versus GNC', matricula: '127394 JZP', calca: '183' },
            '184': { modelo: 'Castrosua CS.40 City Versus GNC', matricula: '129941 KPK', calca: '184' },
            '185': { modelo: 'Castrosua CS.40 City Versus GNC', matricula: '129992 KPK', calca: '185' },
            '187': { modelo: 'Castrosua New City GNC', matricula: '124690 KXD', calca: '187' },
            '188': { modelo: 'Castrosua New City GNC', matricula: '124852 KXD', calca: '188' },
            '227': { modelo: 'Castrosua New City GNC', matricula: '184644 KXD', calca: '227' },
            '170': { modelo: 'Integralia In-Urban', matricula: '3516 JVK', calca: '170' },
            '189': { modelo: 'Integralia In-Urban', matricula: '8273 LDM', calca: '189' },
            '171': { modelo: 'Integralia Tatoo', matricula: '3602 JVK', calca: '171' },
            '190': { modelo: 'Integralia Tatoo', matricula: '8430 LDM', calca: '190' },
            '157': { modelo: 'Mercedes-Benz Citaro C2', matricula: '8536 JDV', calca: '157' },
            '158': { modelo: 'Mercedes-Benz Citaro C2', matricula: '8572 JDV', calca: '158' },
            '159': { modelo: 'Mercedes-Benz Citaro C2', matricula: '8606 JDV', calca: '159' },
            '160': { modelo: 'Mercedes-Benz Citaro C2', matricula: '8628 JDV', calca: '160' },
            '161': { modelo: 'Mercedes-Benz Citaro C2', matricula: '8639 JDV', calca: '161' },
            '162': { modelo: 'Mercedes-Benz Citaro C2', matricula: '8656 JDV', calca: '162' },
            '163': { modelo: 'Mercedes-Benz Citaro C2', matricula: '8725 JDV', calca: '163' },
            '164': { modelo: 'Mercedes-Benz Citaro C2', matricula: '8766 JDV', calca: '164' },
            '165': { modelo: 'Mercedes-Benz Citaro C2', matricula: '8781 JDV', calca: '165' },
            '166': { modelo: 'Mercedes-Benz Citaro C2', matricula: '8804 JDV', calca: '166' },
            '173': { modelo: 'Mercedes-Benz Citaro C2', matricula: '3271 JZW', calca: '173' },
            '174': { modelo: 'Mercedes-Benz Citaro C2', matricula: '3395 JZW', calca: '174' },
            '175': { modelo: 'Mercedes-Benz Citaro C2', matricula: '3355 JZW', calca: '175' },
            '176': { modelo: 'Mercedes-Benz Citaro C2', matricula: '3450 JZW', calca: '176' },
            '177': { modelo: 'Mercedes-Benz Citaro C2', matricula: '3483 JZW', calca: '177' },
            '178': { modelo: 'Mercedes-Benz Citaro C2', matricula: '3565 JZW', calca: '178' },
            '212': { modelo: 'Mercedes-Benz Citaro C2 G', matricula: '3624 JZW', calca: '212' },
            '213': { modelo: 'Mercedes-Benz Citaro C2 G', matricula: '3638 JZW', calca: '213' },
            '214': { modelo: 'Mercedes-Benz Citaro C2 G', matricula: '3760 JZW', calca: '214' },
            '215': { modelo: 'Mercedes-Benz Citaro C2 G', matricula: '3798 JZW', calca: '215' },
            '216': { modelo: 'Mercedes-Benz Citaro C2 G', matricula: '3844 JZW', calca: '216' },
            '217': { modelo: 'Mercedes-Benz Citaro C2 G', matricula: '3898 JZW', calca: '217' },
            '218': { modelo: 'Mercedes-Benz Citaro C2 G', matricula: '3965 JZW', calca: '218' },
            '219': { modelo: 'Mercedes-Benz Citaro C2 G', matricula: '3976 JZW', calca: '219' },
            '220': { modelo: 'Mercedes-Benz Citaro C2 G', matricula: '3988 JZW', calca: '220' },
            '221': { modelo: 'Mercedes-Benz Citaro C2 G', matricula: '4005 JZW', calca: '221' },
            '222': { modelo: 'Mercedes-Benz Citaro C2 G', matricula: '4072 JZW', calca: '222' },
            '223': { modelo: 'Mercedes-Benz Citaro C2 G', matricula: '4104 JZW', calca: '223' },
            '140': { modelo: 'Noge Cittour GNC', matricula: '4057 FTT', calca: '140' },
            '141': { modelo: 'Noge Cittour GNC', matricula: '4197 FTT', calca: '141' },
            '191': { modelo: 'Solaris Urbino IV 12 CNG', matricula: '7507 LJH', calca: '191' },
            '192': { modelo: 'Solaris Urbino IV 12 CNG', matricula: '7266 LJH', calca: '192' },
            '193': { modelo: 'Solaris Urbino IV 12 CNG', matricula: '7432 LJH', calca: '193' },
            '194': { modelo: 'Solaris Urbino IV 12 CNG', matricula: '7552 LJH', calca: '194' },
            '197': { modelo: 'Solaris Urbino IV 12 CNG', matricula: '3371 MBD', calca: '197' },
            '198': { modelo: 'Solaris Urbino IV 12 CNG', matricula: '4551 MKF', calca: '198' },
            '199': { modelo: 'Solaris Urbino IV 12 CNG', matricula: '4568 MKF', calca: '199' },
            '300': { modelo: 'Solaris Urbino IV 12 CNG', matricula: '4590 MKF', calca: '300' },
            '228': { modelo: 'Solaris Urbino IV 18 CNG', matricula: '1046 LJK', calca: '228' },
            '229': { modelo: 'Solaris Urbino IV 18 CNG', matricula: '3449 MBD', calca: '229' },
            '230': { modelo: 'Solaris Urbino IV 18 CNG', matricula: '3486 MBD', calca: '230' },
            '231': { modelo: 'Solaris Urbino IV 18 CNG', matricula: '4602 MKF', calca: '231' },
            '232': { modelo: 'Solaris Urbino IV 18 CNG', matricula: '4622 MKF', calca: '232' },
            '172': { modelo: 'Vectia Veris.12 Hybrid', matricula: '5485 JWH', calca: '172' }
        };

        // --- Variables Globales del Estado y Mapa ---
        let map;
        let busMarkersLayer;
        let routeLineLayer;
        let stopMarkersLayer;
        let allStopMarkers = new Map(); // Para almacenar TODOS los marcadores de parada (incluye los del modo STOP_MAP)
        
        // Intervalos de Polling
        let globalMonitorInterval;
        let currentLineMonitorInterval;
        let stopEstimationInterval;
        let currentStopMarker = null;

        const allRoutes = {}; // Cach√© de rutas (geometr√≠a y variantes)
        const allStopData = {}; // Cach√© global de todas las paradas (num, lat, lng, name)
        const stopDataCache = {}; // Cach√© de paradas de la l√≠nea activa
        const busMarkers = new Map(); // Marcadores de la l√≠nea actual
        const ALL_ACTIVE_BUSES = new Map(); // Cach√© Global para el Buscador

        // --- Referencias de Elementos DOM ---
        const menuScreen = document.getElementById('menu-screen');
        const stopsMapControls = document.getElementById('stops-map-controls');
        const lineViewControls = document.getElementById('line-view-controls');
        const mapContainerWrapper = document.getElementById('map-container-wrapper');
        const homeBtn = document.getElementById('home-btn');
        const headerSubtitle = document.getElementById('header-subtitle');
        const lineViewTitle = document.getElementById('line-view-title');
        const linesListContainer = document.getElementById('lines-list-container');
        const activeLineControls = document.getElementById('active-line-controls');

        const btnShowStopsMap = document.getElementById('btn-show-stops-map');
        const btnShowLinesList = document.getElementById('btn-show-lines-list');
        
        // Nuevas referencias para el buscador de Bus ID
        const busSearchInput = document.getElementById('bus-search-input');
        const busSearchButton = document.getElementById('bus-search-button');
        
        const stopSearchInput = document.getElementById('stop-search-input');
        const stopSearchResults = document.getElementById('stop-search-results');
        
        const routeVariantSelectLine = document.getElementById('route-variant-select-line'); 
        
        const loadingOverlay = document.getElementById('loading-overlay');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const mapContainer = document.getElementById('map');
        const fullscreenIconPath = document.getElementById('fullscreen-path');


        // --- Funciones de Navegaci√≥n y Estado ---

        function navigate(view, newLineId = null) {
            currentView = view;
            lineId = newLineId; // Actualizar la l√≠nea activa
            targetBusIdOnLoad = null; // Resetear el bus objetivo al cambiar de vista principal
            
            // 1. Ocultar todos los contenedores de vista
            menuScreen.classList.add('hidden');
            stopsMapControls.classList.add('hidden');
            lineViewControls.classList.add('hidden');
            mapContainerWrapper.classList.add('hidden');
            homeBtn.classList.add('hidden');
            
            // 2. Detener monitores
            stopLineMonitor();
            stopStopEstimationMonitor();
            clearMapLayers(); 
            
            // 3. Activar la vista solicitada
            if (view === VIEWS.MENU) {
                menuScreen.classList.remove('hidden');
                headerSubtitle.textContent = 'Localizaci√≥n de veh√≠culos y horarios de parada en toda la red.';
            } else if (view === VIEWS.STOP_MAP) {
                stopsMapControls.classList.remove('hidden');
                mapContainerWrapper.classList.remove('hidden');
                homeBtn.classList.remove('hidden');
                headerSubtitle.textContent = 'Todas las paradas activas con buscador.';
                
                loadAllStopsOnMap();
                
            } else if (view === VIEWS.LINE_VIEW) {
                lineViewControls.classList.remove('hidden');
                homeBtn.classList.remove('hidden');
                
                if (lineId) {
                    // Vista de L√≠nea Espec√≠fica (Mapa)
                    mapContainerWrapper.classList.remove('hidden');
                    linesListContainer.classList.add('hidden');
                    activeLineControls.classList.remove('hidden');
                    lineViewTitle.textContent = `L√≠nea ${lineId} en Vivo`;
                    headerSubtitle.textContent = `Ruta, paradas y buses en tiempo real.`;
                    loadRouteVariants(lineId);
                } else {
                    // Vista de Listado de L√≠neas
                    linesListContainer.classList.remove('hidden');
                    activeLineControls.classList.add('hidden');
                    lineViewTitle.textContent = `L√≠neas Bus: Listado`;
                    headerSubtitle.textContent = `Selecciona una l√≠nea para ver su ruta y buses.`;
                    loadLinesList();
                }
            }
            
            // Es CR√çTICO llamar a invalidateSize despu√©s de hacer visible el mapa
            if (mapContainerWrapper.classList.contains('hidden') === false) {
                map.invalidateSize();
                if (view === VIEWS.STOP_MAP && allStopMarkers.size > 0) {
                    centerMapToAllStops();
                } else if (view === VIEWS.LINE_VIEW && !lineId) {
                    // Si estamos en el listado de l√≠neas, pero el contenedor del mapa est√° visible, centrar en Burgos
                    map.setView([42.3459, -3.6969], 14);
                }
            }
        }
        
        function goHome() {
            navigate(VIEWS.MENU);
        }


        // --- Funciones de Utilidad y UI ---

        function toggleMapFullscreen() { 
            const isFullscreen = mapContainer.classList.toggle('map-fullscreen');
            const appContainer = document.getElementById('app-container');
            
            if (isFullscreen) {
                appContainer.style.display = 'none';
                homeBtn.style.display = 'none'; 
                fullscreenIconPath.setAttribute('d', 'M6 18L18 6M6 6l12 12'); 
            } else {
                appContainer.style.display = 'block';
                // Mostrar el bot√≥n de casa si no estamos en el men√∫ principal
                if (currentView !== VIEWS.MENU) homeBtn.style.display = 'block';
                fullscreenIconPath.setAttribute('d', 'M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 4l-5-5');
            }

            map.invalidateSize();
        }

        function showLoading(message = "Obteniendo datos en tiempo real...") {
            const loadingText = loadingOverlay.querySelector('p');
            if (loadingText) loadingText.textContent = message;
            loadingOverlay.classList.remove('hidden');
            // Ocultar mensajes de estado en cualquier modo
            document.getElementById('status-message-stop-map').classList.add('hidden');
            document.getElementById('status-message-line-view').classList.add('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        function showStatus(message, isError = false, targetId = 'status-message-stop-map') {
            const statusBox = document.getElementById(targetId);
            statusBox.textContent = message;
            statusBox.classList.remove('hidden', 'bg-red-100', 'bg-blue-100', 'text-red-800', 'text-blue-800');

            if (isError) {
                statusBox.classList.add('bg-red-100', 'text-red-800');
                console.error("ERROR de la aplicaci√≥n:", message);
            } else {
                statusBox.classList.add('bg-blue-100', 'text-blue-800');
            }
        }
        
        function secondsToTime(seconds) { 
            const sec = parseInt(seconds);
            if (isNaN(sec) || sec < 0) return "Desconocido";

            const minutes = Math.floor(sec / 60);
            
            if (minutes === 0) {
                return sec < 30 ? "Inmediato" : "1 min";
            }
            return `${minutes} min`;
        }

        // --- L√≥gica de la API y Fetching ---

        async function fetchWithRetry(url, retries = 3, isPolling = false) { 
             for (let i = 0; i < retries; i++) {
                try {
                    const headers = new Headers();
                    headers.append('Referer', BASE_URL); 

                    const response = await fetch(CORS_PROXY + encodeURIComponent(url), { headers: headers });
                    
                    if (!response.ok) {
                        if (isPolling && response.status === 403 && i < retries - 1) {
                             console.warn(`[Polling Silencioso] 403 en reintento ${i + 1}. Reintentando...`);
                        } else {
                            throw new Error(`HTTP error! status: ${response.status} (${response.statusText})`);
                        }
                    } else {
                        const text = await response.text();
                        
                        if (!text || text.toLowerCase().trim() === 'null' || text.toLowerCase().trim() === '[]') {
                             return [];
                        }

                        try {
                            let jsonText = text;
                            if (text.startsWith('URL_DECODED:')) {
                                jsonText = decodeURIComponent(text.replace('URL_DECODED:', ''));
                            }
                            return JSON.parse(jsonText);
                        } catch (e) {
                            throw new Error(`Error al procesar la respuesta del servidor (No es JSON v√°lido).`);
                        }
                    }
                } catch (error) {
                    if (i === retries - 1) {
                        throw new Error(`Error final al obtener datos: ${error.message}`);
                    }
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }
        }

        async function fetchBurgosAPI(resourceId, lineId = '', extraParams = {}) { 
             const dynamicParams = new URLSearchParams();

            dynamicParams.set(PORTLET_PREFIX + 'formDate', Date.now());
            dynamicParams.set(PORTLET_PREFIX + 'tipo', '1');
            
            if (lineId) {
                dynamicParams.set(PORTLET_PREFIX + 'line', lineId);
                dynamicParams.set(PORTLET_PREFIX + 'label', lineId);
            }

            for (const key in extraParams) {
                dynamicParams.set(PORTLET_PREFIX + key, extraParams[key]);
            }

            const targetUrl = `${BASE_URL}?${BASE_PARAMS}&p_p_resource_id=${resourceId}&${dynamicParams.toString()}`;
            
            const isPollingCall = resourceId === 'resourceVehicles' || resourceId === 'resourceEstimations';

            try {
                return await fetchWithRetry(targetUrl, 3, isPollingCall); 
            } catch (error) {
                if(!isPollingCall) {
                    const targetStatusBox = currentView === VIEWS.STOP_MAP ? 'status-message-stop-map' : 'status-message-line-view';
                    showStatus(error.message, true, targetStatusBox);
                }
                throw error;
            }
        }
        
        // --- Inicializaci√≥n y Eventos ---
        
        function setupEventListeners() {
            btnShowStopsMap.onclick = () => navigate(VIEWS.STOP_MAP);
            btnShowLinesList.onclick = () => navigate(VIEWS.LINE_VIEW);
            homeBtn.onclick = goHome;
            fullscreenBtn.onclick = toggleMapFullscreen;
            map.on('popupclose', stopStopEstimationMonitor);
            
            // Eventos del Buscador de Bus por ID
            busSearchButton.onclick = searchBusById;
            busSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchBusById();
            });
            
            // Eventos del Buscador de Paradas
            stopSearchInput.addEventListener('input', handleStopSearch);
            
            // Evento para el selector de ruta en el modo LINE_VIEW
            routeVariantSelectLine.onchange = handleRouteVariantChange;
        }

        function initMap() {
            map = L.map('map').setView([42.3459, -3.6969], 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            busMarkersLayer = L.layerGroup().addTo(map);
            routeLineLayer = L.layerGroup().addTo(map);
            stopMarkersLayer = L.layerGroup().addTo(map);

            setupEventListeners();
            
            // Iniciar el monitor global para alimentar el buscador y la info de buses
            startGlobalVehicleMonitor();
            
            // Iniciar en el men√∫ principal
            navigate(VIEWS.MENU);
        }
        
        // --- L√ìGICA DEL BUSCADOR DE BUS POR ID (REINCORPORADA) ---
        
        /**
         * @function searchBusById
         * @description Busca un bus por ID en la cach√© global y navega a su l√≠nea.
         */
        function searchBusById() {
            const busId = busSearchInput.value.trim();
            
            if (!busId || isNaN(busId)) {
                showStatus("Introduzca un ID de autob√∫s num√©rico v√°lido.", true, 'status-message-stop-map');
                return;
            }

            const busData = ALL_ACTIVE_BUSES.get(busId);
            
            if (!busData) {
                showStatus(`Autob√∫s ID ${busId} no encontrado o no activo. Intente de nuevo en ${POLLING_GLOBAL_MS / 1000} segundos.`, true, 'status-message-stop-map');
                return;
            }

            showLoading(`Localizando Bus ID ${busId} en L√≠nea ${busData.lineId}...`);

            // 1. Guardar el ID del bus a enfocar despu√©s de la carga
            targetBusIdOnLoad = busId;

            // 2. Navegar a la vista de l√≠nea espec√≠fica
            navigate(VIEWS.LINE_VIEW, busData.lineId);
            
            // Limpiar el input para la pr√≥xima b√∫squeda
            busSearchInput.value = '';
        }
        
        // --- L√ìGICA DEL MODO LINE_VIEW (Listado y Mapa de L√≠nea) ---

        function loadLinesList() {
            linesListContainer.innerHTML = '';
            
            ALL_LINES.forEach(lineId => {
                const buttonHtml = `
                    <div class="flex items-center justify-between p-3 bg-gray-50 border border-gray-200 rounded-lg shadow-sm hover:bg-gray-100 transition duration-150">
                        <span class="text-lg font-bold text-gray-700">L√≠nea ${lineId}</span>
                        <button data-line-id="${lineId}" class="btn-select-line bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-1 px-3 rounded-full shadow-md transition flex items-center">
                            Ver Mapa ‚û°Ô∏è
                        </button>
                    </div>
                `;
                linesListContainer.insertAdjacentHTML('beforeend', buttonHtml);
            });
            
            // Asignar eventos a los botones de la lista
            document.querySelectorAll('.btn-select-line').forEach(button => {
                button.onclick = (e) => {
                    const lineIdClicked = e.target.closest('button').dataset.lineId;
                    navigate(VIEWS.LINE_VIEW, lineIdClicked);
                };
            });
        }

        async function loadRouteVariants(lineId) {
            try {
                showLoading(`Cargando rutas para la L√≠nea ${lineId}...`);
                
                map.setView([42.3459, -3.6969], 14); 

                const routeData = await fetchBurgosAPI('resourceRoutes', lineId);
                allRoutes[lineId] = routeData;

                routeVariantSelectLine.innerHTML = '<option value="">Seleccione un sentido</option>';
                
                if (!routeData || routeData.length === 0) {
                    showStatus(`L√≠nea ${lineId} sin rutas activas o datos no disponibles.`, false, 'status-message-line-view');
                    clearMapLayers();
                    stopLineMonitor();
                    routeVariantSelectLine.disabled = true;
                    hideLoading();
                    return;
                }

                routeData.forEach(variant => {
                    const option = document.createElement('option');
                    option.value = variant.id;
                    option.textContent = variant.label;
                    routeVariantSelectLine.appendChild(option);
                });
                
                routeVariantSelectLine.disabled = false;
                
                // Cargar la primera variante por defecto
                if (routeData.length > 0) {
                    routeVariantSelectLine.value = routeData[0].id;
                    await handleRouteVariantChange({ target: routeVariantSelectLine });
                }

            } catch (error) {
                showStatus(`Error al cargar variantes de la L√≠nea ${lineId}.`, true, 'status-message-line-view');
                clearMapLayers();
                stopLineMonitor();
            } finally {
                hideLoading();
            }
        }
        
        async function handleRouteVariantChange(event) {
            const variantId = event.target.value;
            
            if (!variantId || !lineId) {
                clearMapLayers();
                stopLineMonitor();
                return;
            }
            
            showLoading("Dibujando ruta y cargando paradas...");
            await renderRouteAndStops(lineId, variantId, 'status-message-line-view');
            
            // Iniciar monitor de la l√≠nea activa para refrescar los buses.
            // La funci√≥n ahora devuelve una promesa que se resuelve con la primera actualizaci√≥n de buses.
            startLineMonitor(lineId).then(() => {
                
                // --- L√ìGICA DE ENFOQUE DE BUS AL NAVEGAR DESDE EL BUSCADOR ID ---
                if (targetBusIdOnLoad) {
                    const busIdToFind = targetBusIdOnLoad;
                    targetBusIdOnLoad = null; // Limpiar la bandera
                    
                    const marker = busMarkers.get(busIdToFind);
                    if (marker) {
                        map.setView([marker.getLatLng().lat, marker.getLatLng().lng], 17);
                        marker.openPopup();
                        showStatus(`Bus ID ${busIdToFind} encontrado en L√≠nea ${lineId}.`, false, 'status-message-line-view');
                    } else {
                         showStatus(`Bus ID ${busIdToFind} ya no est√° activo o no pudo ser localizado.`, true, 'status-message-line-view');
                    }
                }
                // --- FIN L√ìGICA DE ENFOQUE ---
                
            }).catch(e => {
                 console.error("Error en el monitor de l√≠nea:", e);
            });
            
            hideLoading();
            showStatus(`L√≠nea ${lineId} cargada. Sentido: ${event.target.options[event.target.selectedIndex].text}`, false, 'status-message-line-view');
        }

        // --- L√ìGICA DEL MODO STOP_MAP (Todas las Paradas) ---

        async function loadAllStopsOnMap() {
            clearMapLayers();
            allStopMarkers.clear();
            stopSearchResults.innerHTML = '';
            
            if (Object.keys(allStopData).length === 0) {
                showLoading("Cargando todas las paradas por primera vez...");
                try {
                    const allNodesData = await fetchBurgosAPI('resourceNodes', ''); 
                    
                    if (!allNodesData || allNodesData.length === 0) {
                        showStatus('No se encontraron datos de paradas.', true, 'status-message-stop-map');
                        return;
                    }
                    
                    allNodesData.forEach(node => {
                        allStopData[node.num.toString()] = node;
                    });
                    
                } catch (error) {
                    showStatus('Error al cargar la lista global de paradas.', true, 'status-message-stop-map');
                    hideLoading();
                    return;
                }
            }

            // Dibujar todas las paradas
            Object.values(allStopData).forEach(node => {
                const marker = createStopMarker(node.lat, node.lng, node.num.toString(), node.name, 'ALL_STOPS');
                allStopMarkers.set(node.num.toString(), marker);
            });
            
            centerMapToAllStops();
            showStatus(`Mostrando ${Object.keys(allStopData).length} paradas activas. Use el buscador.`, false, 'status-message-stop-map');
            hideLoading();
        }
        
        function handleStopSearch() {
            const query = stopSearchInput.value.trim().toLowerCase();
            stopSearchResults.innerHTML = '';
            
            if (query.length < 2) {
                // Mostrar todos si la b√∫squeda est√° vac√≠a
                allStopMarkers.forEach(marker => marker.setOpacity(1));
                return;
            }

            const matchingStops = Object.values(allStopData).filter(node => 
                node.num.toString().includes(query) || node.name.toLowerCase().includes(query)
            );
            
            let bounds = L.latLngBounds();
            let foundMatch = false;

            allStopMarkers.forEach((marker, id) => {
                const node = allStopData[id];
                const matches = node.num.toString().includes(query) || node.name.toLowerCase().includes(query);
                
                marker.setOpacity(matches ? 1 : 0.2); 

                if (matches) {
                    foundMatch = true;
                    bounds.extend(marker.getLatLng());
                    
                    const resultHtml = `
                        <div class="p-2 border-b border-gray-100 hover:bg-blue-50 cursor-pointer text-gray-700" data-stop-id="${id}">
                            <span class="font-semibold text-blue-600">${id}</span> - ${node.name}
                        </div>
                    `;
                    stopSearchResults.insertAdjacentHTML('beforeend', resultHtml);
                }
            });
            
            document.querySelectorAll('#stop-search-results div').forEach(div => {
                div.onclick = (e) => {
                    const stopId = e.target.closest('div').dataset.stopId;
                    const marker = allStopMarkers.get(stopId);
                    if (marker) {
                        map.setView(marker.getLatLng(), 17); 
                        marker.openPopup();
                        stopSearchResults.innerHTML = '';
                        stopSearchInput.value = stopId;
                    }
                };
            });
            
            if (foundMatch) {
                 map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
        
        function centerMapToAllStops() {
            if (Object.keys(allStopData).length === 0) return;
            const bounds = L.latLngBounds();
            Object.values(allStopData).forEach(node => {
                bounds.extend([node.lat, node.lng]);
            });
            map.fitBounds(bounds);
        }

        // --- L√≥gica Com√∫n de Dibujo ---
        
        function createStopMarker(lat, lng, stopId, stopName, mode) {
             const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'stop-icon',
                    html: '',
                    iconSize: [16, 16],
                    iconAnchor: [8, 8],
                    popupAnchor: [0, -7]
                })
            }).addTo(stopMarkersLayer);
            
            marker.stopId = stopId;
            marker.stopName = stopName;
            marker.mode = mode; 
            
            marker.bindPopup(`<div class="text-gray-600 font-semibold py-2 text-center">${stopName} (${stopId})<br>Cargando horarios...</div>`);
            
            marker.on('popupopen', (e) => {
                const markerTarget = e.target;
                startStopEstimationMonitor('', markerTarget.stopId, markerTarget); 
                stopLineMonitor(); 
            });
            
            marker.on('popupclose', () => {
                // Reactivamos el monitor de l√≠nea si estamos en modo LINE_VIEW
                if (currentView === VIEWS.LINE_VIEW && lineId) {
                    startLineMonitor(lineId);
                }
            });
            
            return marker;
        }

        /**
         * @function renderRouteAndStops
         * @description Dibuja la ruta y las paradas de una l√≠nea espec√≠fica (Modo LINE_VIEW).
         */
        async function renderRouteAndStops(lineId, variantId, statusId) {
            routeLineLayer.clearLayers();
            stopMarkersLayer.clearLayers();
            busMarkers.clear();
            stopDataCache[lineId] = {};
            
            const variant = allRoutes[lineId].find(v => v.id === variantId);
            if (!variant) return;

            // 1. Dibujar la ruta
            drawRoutePath(variant.latLngs);
            
            // 2. Dibujar las paradas
            try {
                // resourceNodes con lineId solo trae las paradas de la l√≠nea
                const nodesData = await fetchBurgosAPI('resourceNodes', lineId); 
                const nodesMap = new Map(nodesData.map(node => [node.num.toString(), node])); 

                variant.routeNode.forEach(routeNode => {
                    const nodeNum = routeNode.num.toString();
                    const fullNodeData = nodesMap.get(nodeNum);
                    
                    if (!fullNodeData) return;

                    stopDataCache[lineId][nodeNum] = fullNodeData;
                    
                    const marker = createStopMarker(fullNodeData.lat, fullNodeData.lng, nodeNum, fullNodeData.name, 'LINE_VIEW');
                    marker.lineId = lineId;
                });

            } catch (error) {
                showStatus(`Error al cargar datos de paradas de la l√≠nea (resourceNodes).`, true, statusId);
            }
        }

        function drawRoutePath(latLngs) { 
             if (!latLngs || latLngs.length === 0) return;
            const path = latLngs.map(p => [p.lat, p.lng]);
            const polyline = L.polyline(path, { color: '#2563EB', weight: 5, opacity: 0.7 }).addTo(routeLineLayer);
            map.fitBounds(polyline.getBounds(), { padding: [50, 50] }); 
            
            if (L.Polyline.SnakeFlow) {
                 L.polyline(path, { color: '#2563EB', weight: 0, flow: {length: 30, trail: 5, color: '#1E40AF', speed: 1} }).addTo(routeLineLayer);
            }
        }
        
        function clearMapLayers() { 
             busMarkersLayer.clearLayers();
             routeLineLayer.clearLayers();
             stopMarkersLayer.clearLayers();
             busMarkers.clear();
             allStopMarkers.clear();
        }

        // --- L√≥gica de Polling ---
        
        function stopLineMonitor() { 
            if (currentLineMonitorInterval) {
                clearInterval(currentLineMonitorInterval);
                currentLineMonitorInterval = null;
            }
        }
        
        /**
         * @function startLineMonitor
         * @description Inicia el polling de buses para una l√≠nea, devolviendo una promesa que resuelve
         * tras la primera actualizaci√≥n exitosa.
         * @param {string} lineId - ID de la l√≠nea a monitorizar.
         * @returns {Promise<void>}
         */
        function startLineMonitor(lineId) {
            stopLineMonitor();
            let firstUpdateResolve;
            let firstUpdatePromise = new Promise(resolve => firstUpdateResolve = resolve);
            
            const poller = async () => {
                try {
                    const vehiclesData = await fetchBurgosAPI('resourceVehicles', lineId);
                    updateBusMarkers(lineId, vehiclesData);
                    
                    if (firstUpdateResolve) {
                        firstUpdateResolve();
                        firstUpdateResolve = null; // No resolver m√°s la promesa
                    }
                } catch (e) {
                    console.log(`[Polling Fallido NO fatal] Error al actualizar la L√≠nea ${lineId}.`);
                }
            };
            
            poller(); 
            currentLineMonitorInterval = setInterval(poller, POLLING_LINE_MS);
            console.log(`Monitor de L√≠nea ${lineId} iniciado: Polling cada ${POLLING_LINE_MS / 1000}s`);
            
            return firstUpdatePromise;
        }
        
        function stopStopEstimationMonitor() { 
            if (stopEstimationInterval) {
                clearInterval(stopEstimationInterval);
                stopEstimationInterval = null;
            }
            currentStopMarker = null;
        }

        function startStopEstimationMonitor(lineId, stopId, marker) { 
            stopStopEstimationMonitor();
            
            currentStopMarker = marker; 
            
            const poller = async () => {
                if (marker.getPopup().isOpen()) {
                    await loadEstimationsForStop(marker.lineId || '', stopId, marker, true); 
                } else {
                    stopStopEstimationMonitor();
                }
            };

            poller(); 
            stopEstimationInterval = setInterval(poller, POLLING_STOP_MS);
            console.log(`Monitor de Parada ${stopId} iniciado: Polling cada ${POLLING_STOP_MS / 1000}s`);
        }
        
        async function loadEstimationsForStop(lineId, stopId, marker, isPollingUpdate = false) { 
            let stopName = '';
            if (marker.mode === 'LINE_VIEW') {
                stopName = stopDataCache[lineId] && stopDataCache[lineId][stopId] ? stopDataCache[lineId][stopId].name : `Parada ${stopId}`;
            } else {
                stopName = allStopData[stopId] ? allStopData[stopId].name : `Parada ${stopId}`;
            }
            
            const stopNameHeader = `<div class="font-bold text-lg text-blue-600 text-center mb-2">${stopName}</div>`;

            if (!isPollingUpdate) {
                marker.getPopup().setContent(`
                    ${stopNameHeader}
                    <div class="text-gray-600 font-semibold text-center py-2">Cargando horarios de llegada...</div>
                `);
            }

            try {
                const estimationsData = await fetchBurgosAPI('resourceEstimations', '', { 
                    'nodoIds': stopId,
                });

                let popupContent = stopNameHeader;
                let foundEstimations = false;
                const allEstimates = [];
                
                 if (estimationsData && Array.isArray(estimationsData) && estimationsData.length > 0) {
                    const stopData = estimationsData.find(item => item.nodoId === stopId);
                    
                    if (stopData && stopData.routeEstimationByNode) {
                        stopData.routeEstimationByNode.forEach(routeEst => {
                            if (routeEst.publicEstimationVHExts) {
                                routeEst.publicEstimationVHExts.forEach(est => {
                                    if (est.destination) {
                                        allEstimates.push({
                                            line: routeEst.line,
                                            destination: routeEst.destination,
                                            seconds: est.seconds
                                        });
                                    }
                                });
                            }
                        });
                    }
                }
                
                allEstimates.sort((a, b) => a.seconds - b.seconds);

                if (allEstimates.length > 0) {
                    popupContent += `
                        <div class="text-xs text-gray-500 text-center mb-1">Actualizado: ${new Date().toLocaleTimeString()}</div>
                        <table class="min-w-full text-sm">
                            <thead>
                                <tr>
                                    <th class="text-left font-semibold text-gray-700">L√≠nea/Destino</th>
                                    <th class="text-right font-semibold text-gray-700">Llegada</th>
                                </tr>
                            </thead>
                            <tbody>`;

                    allEstimates.forEach(est => {
                        popupContent += `<tr>
                                            <td class="pr-4 border-b border-gray-100 py-1">L${est.line} - ${est.destination}</td>
                                            <td class="text-right font-bold text-blue-700 border-b border-gray-100">${secondsToTime(est.seconds)}</td>
                                        </tr>`;
                        foundEstimations = true;
                    });
                    popupContent += `</tbody></table>`;
                }
                
                if (!foundEstimations) {
                    popupContent += `<p class="mt-2 text-sm text-gray-500 text-center">Sin estimaciones en este momento para esta parada.</p>`;
                }

                popupContent += `<button onclick="window.toggleMapFullscreen()" class="fullscreen-toggle-btn w-full mt-3">Pantalla Completa</button>`; 

                marker.getPopup().setContent(popupContent);
                marker.update(); 

            } catch (error) {
                marker.getPopup().setContent(`
                    ${stopNameHeader}
                    <div class="text-red-600 text-center">Error al cargar horarios. Reintentando...</div>
                `);
                console.error("Error al cargar estimaciones:", error);
            }
        }
        
        // --- L√≥gica de Buses y Buscador Global ---

        function startGlobalVehicleMonitor() { 
             if (globalMonitorInterval) {
                 clearInterval(globalMonitorInterval);
             }
             
             updateAllVehiclesGlobally();
             globalMonitorInterval = setInterval(updateAllVehiclesGlobally, POLLING_GLOBAL_MS);
             console.log(`Monitor Global de Buses iniciado: Polling cada ${POLLING_GLOBAL_MS / 1000}s`);
        }
        
        async function updateAllVehiclesGlobally() { 
             const linePromises = ALL_LINES.map(lineId => 
                 fetchBurgosAPI('resourceVehicles', lineId)
                     .then(data => ({ lineId, data }))
                     .catch(() => ({ lineId, data: [] }))
             );

             const results = await Promise.all(linePromises);
             
             const newActiveBuses = new Map();
             
             results.forEach(result => {
                 if (Array.isArray(result.data)) {
                     result.data.forEach(bus => {
                         newActiveBuses.set(bus.id.toString(), {
                             ...bus, 
                             lineId: result.lineId 
                         });
                     });
                 }
             });

             ALL_ACTIVE_BUSES.clear();
             newActiveBuses.forEach((bus, id) => ALL_ACTIVE_BUSES.set(id, bus));
        }

        function getRouteDestination(lineId, routeId) { 
            const lineVariants = allRoutes[lineId];
            if (!lineVariants) return "Cargando...";
            const variant = lineVariants.find(v => v.routeNode && v.routeNode.length > 0 && v.routeNode[0].routeId === routeId);
            return variant ? variant.label : "Desconocido";
        }

        async function loadNextStopEstimation(busId, lineId, marker) { 
            const busData = ALL_ACTIVE_BUSES.get(busId.toString()); 
            const fleetData = BUS_FLEET_DATA[busId];
            
            if (!busData) {
                marker.setPopupContent(`<div class="text-red-600">Bus ID ${busId} no encontrado o ha desaparecido.</div>`);
                return;
            }

            try {
                const destination = getRouteDestination(lineId, busData.ruta);

                let fleetInfo = `
                    <div class="text-sm mt-2 p-2 bg-gray-50 rounded-lg border border-red-300">
                        <p class="font-semibold text-gray-700">Flota: <span class="text-red-600">Informaci√≥n desconocida (ID no mapeado)</span></p>
                    </div>
                `;

                if (fleetData) {
                    fleetInfo = `
                        <div class="text-sm mt-2 p-2 bg-gray-50 rounded-lg border border-gray-200">
                            <p><span class="font-semibold text-gray-700">Calca:</span> ${fleetData.calca}</p>
                            <p><span class="font-semibold text-gray-700">Modelo:</span> ${fleetData.modelo}</p>
                            <p><span class="font-semibold text-gray-700">Matr√≠cula:</span> ${fleetData.matricula}</p>
                        </div>
                    `;
                }
                
                const popupContent = `
                    <div class="font-bold text-lg text-blue-600 border-b pb-2">BUS ID: ${busId} (L√≠nea ${lineId})</div>
                    <p class="text-sm mt-2">Destino: <span class="font-semibold">${destination}</span></p>
                    ${fleetInfo}
                    <p class="text-xs text-gray-500 mt-2 text-center">Datos en tiempo real (Bus: ${POLLING_LINE_MS / 1000}s)</p>
                    <button onclick="window.toggleMapFullscreen()" class="fullscreen-toggle-btn w-full">Pantalla Completa</button>
                `;
                
                marker.setPopupContent(popupContent);
                
            } catch (error) {
                marker.setPopupContent(`<div class="text-red-600">Error al cargar info del bus.</div>`);
                console.error("Error al cargar estimaci√≥n del veh√≠culo:", error);
            }
        }
        
        function updateBusMarkers(lineId, vehiclesData) { 
             const vehicles = vehiclesData || [];
             const activeIds = new Set();
             
             vehicles.forEach(bus => {
                 const busId = bus.id.toString();
                 const marker = busMarkers.get(busId);
                 activeIds.add(busId);

                 if (isNaN(bus.lat) || isNaN(bus.lng)) {
                     console.warn(`Bus ID ${busId} tiene coordenadas inv√°lidas. Omitiendo actualizaci√≥n.`);
                     return; 
                 }

                 if (marker) {
                     marker.setLatLng([bus.lat, bus.lng]);
                 } else {
                     const icon = L.divIcon({
                         className: 'bus-icon',
                         html: `<span class="leading-none text-sm">${busId}</span>`,
                         iconSize: [36, 36],
                         iconAnchor: [18, 18]
                     });

                     const newMarker = L.marker([bus.lat, bus.lng], { icon: icon, title: `Bus ID: ${busId}` }).addTo(busMarkersLayer);
                     newMarker.bindPopup(`<div class="text-gray-600 font-semibold py-2 text-center">Cargando datos del Bus ID ${busId}...</div>`);
                     
                     newMarker.on('popupopen', (e) => {
                         loadNextStopEstimation(bus.id, lineId, e.target);
                         stopStopEstimationMonitor();
                     });
                     
                     busMarkers.set(busId, newMarker);
                 }
             });

             busMarkers.forEach((marker, id) => {
                 if (!activeIds.has(id.toString())) {
                     busMarkersLayer.removeLayer(marker);
                     busMarkers.delete(id);
                 }
             });
             
             vehicles.forEach(bus => {
                  ALL_ACTIVE_BUSES.set(bus.id.toString(), { ...bus, lineId });
             });
        }

        // Exponer la funci√≥n globalmente para que los popups puedan llamarla
        window.toggleMapFullscreen = toggleMapFullscreen;
        
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
